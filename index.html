<html>
<head>
<meta charset="utf8">
<meta name="viewport" content="width=device-width, user-scalable=no">
<title>untitled</title>
<style>

body {
	margin : 0px;
}

</style>

<script src="jquery.js"></script>
<script src="index.js"></script>
<script src="utils.js"></script>

</head>
<body>
<script>

function drawSVG(type, attributes, style) {
    return $(document.createElementNS('http://www.w3.org/2000/svg', type)).attr(attributes).myCss(style)
}

function drawGrapher() {
	var size = [window.innerWidth, window.innerHeight]
	var d = $('<div style="position:absolute;left:0px;top:0px;width:' + size[0] + 'px;height:' + size[1] + 'px;background:lightgreen"/>')
	var svg = $('<svg style="width:100%;height:100%"/>')
	d.append(svg)

	var model = {
		points : []
	}
	model.points.push([_.time(), 0])

	var updateTimer = 0
	function update() {
		clearTimeout(updateTimer)

		var now = _.time()
		svg.empty()

		var timeSpan = 4000
		var leftTime = now - (2/3)*timeSpan
		var rightTime = now + (1/3)*timeSpan

		var rightP = [now, 0]
		var rightPos = [_.lerp(leftTime, 0, rightTime, size[0], rightP[0]), size[1] / 2]
		for (var i = model.points.length - 1; i >= 0; i--) {
			var p = model.points[i]
			var pos = [
				_.lerp(leftTime, 0, rightTime, size[0], p[0]),
				rightPos[1] + rightP[1]
			]

			if (isNaN(pos[0]) || isNaN(pos[1]) || isNaN(rightPos[0]) || isNaN(rightPos[1])) {
				console.log('wtf?: ' + size)
				return
			}

			svg.append(drawSVG('line', {
				x1 : pos[0],
				y1 : pos[1],
				x2 : rightPos[0],
				y2 : rightPos[1]
			}, 'stroke-width:7px;stroke:green'))

			rightP = p
			rightPos = pos

			if (rightPos[0] < 0) break
		}

		updateTimer = setTimeout(function () {
			var lastP = model.points.slice(-1)[0]
			if (model.points.length > 1 && lastP[1] == 0) {
				lastP[0] = _.time()
			} else {
				model.points.push([_.time(), 0])
			}
			update()
		}, 100)
	}
	update()

	grabMouseRelative(d, function (diff) {
		model.points.push([_.time(), -diff[1]])
		update()
	})

	return d
}

$(function () {
	function update() {
		$('body').append(drawGrapher())
	}
	update()
	$(window).resize(update)
})

</script>
</body>
</html>
